{% extends 'layout.html' %}

{% block title %}销售记录 - 书店管理系统{% endblock %}

{% block header %}销售管理{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex">
            <input type="date" id="start-date" class="form-control me-2" placeholder="开始日期">
            <input type="date" id="end-date" class="form-control me-2" placeholder="结束日期">
            <button id="filter-btn" class="btn btn-outline-primary me-2">筛选</button>
            <button id="reset-btn" class="btn btn-outline-secondary">重置</button>
        </div>
        <a href="/sales/add" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> 新增销售
        </a>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>销售编号</th>
                            <th>图书信息</th>
                            <th>数量</th>
                            <th>单价</th>
                            <th>销售金额</th>
                            <th>销售日期</th>
                            <th>销售员</th>
                            <th>备注</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table">
                        <tr>
                            <td colspan="8" class="text-center">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 分页组件 -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="pagination-info">
                    显示 <span id="start-item">0</span> 到 <span id="end-item">0</span> 条，共 <span id="total-items">0</span>
                    条记录
                </div>
                <nav>
                    <ul class="pagination" id="pagination">
                        <!-- 分页链接将由JS动态生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- 销售统计卡片 -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">销售总额</h5>
                <h2 id="total-sales">¥ 0.00</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">销售数量</h5>
                <h2 id="total-quantity">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">交易笔数</h5>
                <h2 id="total-records">0</h2>
            </div>
        </div>
    </div>
</div>

<!-- 畅销书统计表格 -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">畅销图书排行</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>图书名称</th>
                        <th>销售数量</th>
                        <th>销售金额</th>
                    </tr>
                </thead>
                <tbody id="best-sellers-table">
                    <tr>
                        <td colspan="3" class="text-center">加载中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 初始化变量
        let currentPage = 1;
        let startDate = '';
        let endDate = '';
        let salesData = [];

        // 获取token
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        // 设置请求头
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };

        // 加载销售记录
        const loadSales = (page = 1, filters = {}) => {
            let queryParams = `page=${page}&per_page=10`;
            if (filters.start_date) {
                queryParams += `&start_date=${filters.start_date}`;
            }
            if (filters.end_date) {
                queryParams += `&end_date=${filters.end_date}`;
            }

            fetch(`/api/sales/records?${queryParams}`, { headers })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        salesData = result.data.items;
                        renderSales(result.data);
                        renderPagination(result.data.meta);
                        updatePaginationInfo(result.data.meta);
                    } else {
                        console.error('获取销售记录失败:', result.message);
                        document.getElementById('sales-table').innerHTML =
                            `<tr><td colspan="8" class="text-center text-danger">获取销售记录失败: ${result.message}</td></tr>`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('sales-table').innerHTML =
                        '<tr><td colspan="8" class="text-center text-danger">加载失败，请检查网络连接</td></tr>';
                });

            // 加载销售统计
            loadSalesStats(filters);
        };

        // 加载销售统计
        const loadSalesStats = (filters = {}) => {
            let queryParams = '';
            if (filters.start_date) {
                queryParams += `start_date=${filters.start_date}&`;
            }
            if (filters.end_date) {
                queryParams += `end_date=${filters.end_date}&`;
            }

            fetch(`/api/sales/stats?${queryParams}`, { headers })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        // 更新统计卡片
                        document.getElementById('total-sales').textContent = `¥ ${result.data.total_sales.toFixed(2)}`;
                        document.getElementById('total-quantity').textContent = result.data.total_quantity;
                        document.getElementById('total-records').textContent = result.data.total_records;

                        // 更新畅销书表格
                        const bestSellersTable = document.getElementById('best-sellers-table');
                        if (result.data.book_stats && result.data.book_stats.length > 0) {
                            bestSellersTable.innerHTML = '';

                            // 按销售额降序排序
                            const sortedBooks = result.data.book_stats.sort((a, b) => b.total_amount - a.total_amount);

                            sortedBooks.forEach(book => {
                                bestSellersTable.innerHTML += `
                                    <tr>
                                        <td>${book.book_title}</td>
                                        <td>${book.total_quantity}</td>
                                        <td>¥ ${book.total_amount.toFixed(2)}</td>
                                    </tr>
                                `;
                            });
                        } else {
                            bestSellersTable.innerHTML = '<tr><td colspan="3" class="text-center">暂无销售数据</td></tr>';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading sales stats:', error);
                });
        };

        // 渲染销售表格
        const renderSales = (data) => {
            const salesTable = document.getElementById('sales-table');

            if (data.items.length === 0) {
                salesTable.innerHTML = '<tr><td colspan="8" class="text-center">没有找到销售记录</td></tr>';
                return;
            }

            salesTable.innerHTML = '';
            data.items.forEach(sale => {
                salesTable.innerHTML += `
                    <tr>
                        <td>${sale.sale_id}</td>
                        <td>${sale.book_title}</td>
                        <td>${sale.quantity}</td>
                        <td>¥${sale.sale_price.toFixed(2)}</td>
                        <td>¥${sale.total_amount.toFixed(2)}</td>
                        <td>${sale.sale_time}</td>
                        <td>${sale.seller_name}</td>
                        <td>${sale.remark || '-'}</td>
                    </tr>
                `;
            });
        };

        // 渲染分页组件
        const renderPagination = (meta) => {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // 上一页按钮
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${meta.page <= 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${meta.page - 1}">上一页</a>`;
            pagination.appendChild(prevLi);

            // 页码按钮
            const startPage = Math.max(1, meta.page - 2);
            const endPage = Math.min(meta.pages, meta.page + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === meta.page ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                pagination.appendChild(pageLi);
            }

            // 下一页按钮
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${meta.page >= meta.pages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${meta.page + 1}">下一页</a>`;
            pagination.appendChild(nextLi);

            // 添加页码点击事件
            document.querySelectorAll('.page-link').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    if (page > 0 && page <= meta.pages) {
                        currentPage = page;
                        loadSales(currentPage, { start_date: startDate, end_date: endDate });
                    }
                });
            });
        };

        // 更新分页信息
        const updatePaginationInfo = (meta) => {
            const start = (meta.page - 1) * meta.per_page + 1;
            const end = Math.min(start + meta.per_page - 1, meta.total);

            document.getElementById('start-item').textContent = meta.total > 0 ? start : 0;
            document.getElementById('end-item').textContent = end;
            document.getElementById('total-items').textContent = meta.total;
        };

        // 筛选按钮事件
        document.getElementById('filter-btn').addEventListener('click', function () {
            startDate = document.getElementById('start-date').value;
            endDate = document.getElementById('end-date').value;

            currentPage = 1; // 重置到第一页
            loadSales(currentPage, { start_date: startDate, end_date: endDate });
        });

        // 重置按钮事件
        document.getElementById('reset-btn').addEventListener('click', function () {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            startDate = '';
            endDate = '';

            currentPage = 1; // 重置到第一页
            loadSales(currentPage);
        });

        // 初始加载
        loadSales();
    });
</script>
{% endblock %}