{% extends 'layout.html' %}

{% block title %}添加销售记录 - 书店管理系统{% endblock %}

{% block header %}添加销售记录{% endblock %}

{% block header_buttons %}
<div>
    <a href="/sales" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> 返回销售列表
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- 左侧：图书搜索和结果 -->
    <div class="col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold">图书搜索</h6>
            </div>
            <div class="card-body">
                <form id="book-search-form">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="book-search" placeholder="输入书名、作者或ISBN...">
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                    </div>
                </form>

                <!-- 搜索结果列表 -->
                <div class="table-responsive mt-3">
                    <table class="table table-bordered table-hover" id="search-results-table">
                        <thead>
                            <tr>
                                <th>ISBN</th>
                                <th>书名</th>
                                <th>库存</th>
                                <th>价格</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="search-results">
                            <tr>
                                <td colspan="5" class="text-center">请输入关键词搜索图书</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 加载指示器 -->
                <div id="search-loading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">搜索中...</span>
                    </div>
                    <p class="mt-2">正在搜索图书...</p>
                </div>

                <!-- 未找到结果提示 -->
                <div id="no-results" class="text-center py-4" style="display: none;">
                    <i class="bi bi-search" style="font-size: 2rem;"></i>
                    <p class="mt-2">未找到匹配的图书</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 右侧：购物车和结账 -->
    <div class="col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold">销售清单</h6>
            </div>
            <div class="card-body">
                <!-- 购物车表格 -->
                <div class="table-responsive">
                    <table class="table table-bordered" id="cart-table">
                        <thead>
                            <tr>
                                <th>书名</th>
                                <th>单价</th>
                                <th>数量</th>
                                <th>小计</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="cart-items">
                            <tr>
                                <td colspan="5" class="text-center">购物车为空</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end fw-bold">总计:</td>
                                <td id="cart-total" class="fw-bold">¥0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- 客户信息 -->
                <div class="mt-3">
                    <div class="mb-3">
                        <label for="customer-name" class="form-label">客户姓名 (可选)</label>
                        <input type="text" class="form-control" id="customer-name">
                    </div>
                    <div class="mb-3">
                        <label for="customer-phone" class="form-label">客户电话 (可选)</label>
                        <input type="text" class="form-control" id="customer-phone">
                    </div>
                    <div class="mb-3">
                        <label for="sale-notes" class="form-label">备注 (可选)</label>
                        <textarea class="form-control" id="sale-notes" rows="2"></textarea>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" id="checkout-btn" disabled>
                            <i class="bi bi-cart-check"></i> 完成销售
                        </button>
                        <button class="btn btn-outline-secondary" id="clear-cart-btn" disabled>
                            <i class="bi bi-trash"></i> 清空购物车
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 调整数量Modal -->
<div class="modal fade" id="adjustQuantityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">调整数量</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="book-title-display" class="form-label">图书</label>
                    <input type="text" class="form-control" id="book-title-display" readonly>
                </div>
                <div class="mb-3">
                    <label for="adjust-price" class="form-label">单价 (¥)</label>
                    <input type="number" class="form-control" id="adjust-price" step="0.01" min="0">
                </div>
                <div class="mb-3">
                    <label for="adjust-quantity" class="form-label">数量</label>
                    <input type="number" class="form-control" id="adjust-quantity" min="1">
                </div>
                <div class="mb-3">
                    <label for="stock-display" class="form-label">当前库存</label>
                    <input type="text" class="form-control" id="stock-display" readonly>
                </div>
                <div class="alert alert-danger" id="adjust-error" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-adjust">确认</button>
            </div>
        </div>
    </div>
</div>

<!-- 销售完成Modal -->
<div class="modal fade" id="saleCompleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">销售完成</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <i class="bi bi-check-circle" style="font-size: 3rem; color: green;"></i>
                <h4 class="mt-3">销售记录已保存</h4>
                <p>总金额: <span id="final-amount" class="fw-bold">¥0.00</span></p>
                <p>销售时间: <span id="sale-time"></span></p>
            </div>
            <div class="modal-footer">
                <a href="/sales" class="btn btn-secondary">返回销售列表</a>
                <button type="button" class="btn btn-primary" id="new-sale-btn">继续添加销售</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/sale.js"></script>
{% endblock %}