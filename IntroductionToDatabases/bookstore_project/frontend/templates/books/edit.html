{% extends 'layout.html' %}

{% block title %}编辑图书 - 书店管理系统{% endblock %}

{% block header %}编辑图书{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-body">
                <form id="book-form">
                    <input type="hidden" id="book-id">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="isbn" class="form-label">ISBN</label>
                            <input type="text" class="form-control" id="isbn" name="isbn" required>
                        </div>
                        <div class="col-md-6">
                            <label for="title" class="form-label">书名</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="author" class="form-label">作者</label>
                            <input type="text" class="form-control" id="author" name="author" required>
                        </div>
                        <div class="col-md-6">
                            <label for="publisher" class="form-label">出版社</label>
                            <input type="text" class="form-control" id="publisher" name="publisher" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="retail_price" class="form-label">零售价 (¥)</label>
                            <input type="number" class="form-control" id="retail_price" name="retail_price" step="0.01"
                                min="0" required>
                        </div>
                        <div class="col-md-6">
                            <label for="stock" class="form-label">库存数量</label>
                            <input type="number" class="form-control" id="stock" name="stock" min="0" value="0">
                        </div>
                    </div>

                    <div class="alert alert-danger" id="error-alert" style="display: none;"></div>
                    <div class="alert alert-success" id="success-alert" style="display: none;"></div>

                    <div class="d-flex justify-content-between">
                        <a href="/books" class="btn btn-secondary">返回列表</a>
                        <button type="submit" class="btn btn-primary">保存修改</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 获取token
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        // 设置请求头
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };

        // 获取图书ID
        const urlParts = window.location.pathname.split('/');
        const bookId = urlParts[urlParts.length - 1];

        // 加载图书信息
        fetch(`/api/books/${bookId}`, { headers })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    const book = result.data;

                    // 填充表单
                    document.getElementById('book-id').value = book.book_id;
                    document.getElementById('isbn').value = book.isbn;
                    document.getElementById('title').value = book.title;
                    document.getElementById('author').value = book.author;
                    document.getElementById('publisher').value = book.publisher;
                    document.getElementById('retail_price').value = book.retail_price;
                    document.getElementById('stock').value = book.stock;
                } else {
                    alert(`获取图书信息失败: ${result.message}`);
                    window.location.href = '/books';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取图书信息失败，请稍后重试');
                window.location.href = '/books';
            });

        // 表单提交处理
        document.getElementById('book-form').addEventListener('submit', function (e) {
            e.preventDefault();

            // 隐藏提示信息
            document.getElementById('error-alert').style.display = 'none';
            document.getElementById('success-alert').style.display = 'none';

            // 获取表单数据
            const formData = {
                isbn: document.getElementById('isbn').value,
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                publisher: document.getElementById('publisher').value,
                retail_price: parseFloat(document.getElementById('retail_price').value),
                stock: parseInt(document.getElementById('stock').value) || 0
            };

            // 发送请求
            fetch(`/api/books/${bookId}`, {
                method: 'PUT',
                headers,
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        // 显示成功信息
                        const successAlert = document.getElementById('success-alert');
                        successAlert.textContent = '图书信息更新成功！';
                        successAlert.style.display = 'block';

                        // 3秒后自动跳转到图书列表
                        setTimeout(() => {
                            window.location.href = '/books';
                        }, 3000);
                    } else {
                        // 显示错误信息
                        const errorAlert = document.getElementById('error-alert');
                        errorAlert.textContent = result.message || '更新图书信息失败';
                        errorAlert.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const errorAlert = document.getElementById('error-alert');
                    errorAlert.textContent = '网络错误，请稍后重试';
                    errorAlert.style.display = 'block';
                });
        });
    });
</script>
{% endblock %}