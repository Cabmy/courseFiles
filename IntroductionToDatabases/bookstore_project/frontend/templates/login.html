<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录 - 书店管理系统</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        html,
        body {
            height: 100%;
        }

        body {
            display: flex;
            align-items: center;
            background-color: #f5f5f5;
        }

        .form-signin {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            margin: auto;
        }

        .form-signin .form-floating:focus-within {
            z-index: 2;
        }

        .form-signin input[type="text"] {
            margin-bottom: -1px;
            border-bottom-right-radius: 0;
            border-bottom-left-radius: 0;
        }

        .form-signin input[type="password"] {
            margin-bottom: 10px;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="form-signin">
            <div class="text-center mb-4">
                <h1 class="h3 mb-3 fw-normal">书店管理系统</h1>
                <p class="text-muted">请登录以访问系统</p>
            </div>

            <div class="card">
                <div class="card-body">
                    <form id="login-form">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="username" placeholder="用户名" required>
                            <label for="username">用户名</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="password" class="form-control" id="password" placeholder="密码" required>
                            <label for="password">密码</label>
                        </div>

                        <div class="alert alert-danger" id="error-alert" style="display: none;"></div>

                        <button class="w-100 btn btn-lg btn-primary" type="submit" id="login-btn">登录</button>
                    </form>
                </div>
            </div>
            <p class="mt-5 mb-3 text-muted text-center">&copy; 2025 书店管理系统</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 检查是否已经登录，如果已登录则重定向到仪表盘
            const token = localStorage.getItem('token');
            if (token) {
                window.location.href = '/dashboard';
                return;
            }

            // 登录表单提交
            document.getElementById('login-form').addEventListener('submit', function (e) {
                e.preventDefault();

                // 获取表单数据
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;

                // 禁用登录按钮
                const loginBtn = document.getElementById('login-btn');
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 正在登录...';

                // 隐藏错误提示
                document.getElementById('error-alert').style.display = 'none';

                // 发送登录请求
                fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                })
                    .then(response => response.json())
                    .then(result => {
                        // 始终记录完整的API响应，便于调试
                        console.log("Login API response:", JSON.stringify(result, null, 2));

                        if (result.status === 'success' && result.data && typeof result.data.token === 'string' && result.data.token.trim() !== '') {
                            const tokenToStore = result.data.token.trim();
                            console.log("登录成功，从API获取的有效令牌:", tokenToStore);

                            // 保存令牌和用户信息
                            localStorage.setItem('token', tokenToStore);
                            if (result.data.user) {
                                localStorage.setItem('user', JSON.stringify(result.data.user));
                                console.log("用户信息已存储到 localStorage:", localStorage.getItem('user'));
                            } else {
                                console.warn("登录响应中缺少用户信息 (result.data.user)");
                                localStorage.removeItem('user'); // 清除可能存在的旧用户数据
                            }
                            console.log("令牌已存储到 localStorage:", localStorage.getItem('token'));

                            // 跳转到仪表盘
                            window.location.href = '/dashboard';
                        } else {
                            let errorMessage = '登录失败';
                            if (result.message) {
                                errorMessage = result.message;
                            } else if (!result.data || typeof result.data.token !== 'string' || result.data.token.trim() === '') {
                                errorMessage = '登录凭证无效或服务器未返回有效令牌。';
                                console.error('从API获取的令牌数据无效:', result.data ? result.data.token : 'result.data 为 undefined');
                            }

                            // 显示错误信息
                            const errorAlert = document.getElementById('error-alert');
                            errorAlert.textContent = errorMessage;
                            errorAlert.style.display = 'block';

                            // 恢复登录按钮
                            // const loginBtn = document.getElementById('login-btn'); // 此变量已在外部定义
                            loginBtn.disabled = false;
                            loginBtn.innerHTML = '登录';
                        }
                    })
                    .catch(error => {
                        console.error('登录请求本身发生错误:', error);

                        // 显示错误信息
                        const errorAlert = document.getElementById('error-alert');
                        errorAlert.textContent = '网络错误，请稍后重试';
                        errorAlert.style.display = 'block';

                        // 恢复登录按钮
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = '登录';
                    });
            });
        });
    </script>
</body>

</html>